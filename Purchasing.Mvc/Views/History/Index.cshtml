@using System.Web.Configuration
@model FilteredOrderListModelDto
           
@{
    var extra = "";
    if(!string.IsNullOrWhiteSpace(Model.ShowLast))
    {
        extra = " completed this month";
    }
    ViewBag.Title = "Orders" + extra;
    ViewBag.SingleColumn = false;
    ViewBag.GetMethod = "Index";
    ViewBag.LoadTableTools = true;
    ViewBag.LoadFixedHeaders = true;
    ViewBag.LastRefreshTitle = string.Format("The data on this page is current as of {0}-- recent changes may make take up to five minutes to process. Press F5 to refresh.", @ViewBag.IndexLastModified.ToString("dddd h:mm:ss tt"));
    ViewBag.LastRefresh = string.Format("Results current as of {0}", @ViewBag.IndexLastModified.ToString("dddd h:mm tt"));
    ViewBag.CustomDataTable = true;
   
}

@section SubNav
{
    <span id="refreshMessage" title="@ViewBag.LastRefreshTitle" class="showTip" style="position: relative; top: -20px; font-style: italic;">
        @ViewBag.LastRefresh 
    </span>
	<ul class='navigation'>
        @*<li>@Html.ActionLink("Create New", "Create")</li>*@
        @if (string.IsNullOrWhiteSpace(Model.ShowLast))
        {
            <li>@*@Html.ActionLink("Filters", "filters", "", new { @class = "button" })*@
                <a href="#" id="filterToggle" class="button selected">Filters</a>
            </li>
        }
        <li>@Html.ActionLink("Update Column Preferences", "ColumnPreferences", "User", new { id = User.Identity.Name, fromList = true }, new { @class = "button" })</li>
	</ul>
}


@section AdditionalScripts
{

    @Scripts.Render("~/bundles/history")
    <script type="text/javascript">
        $(function() {
            var table = $(".dt-table, .datatable").dataTable({
                bJQueryUI: false,
                sPaginationType: "full_numbers",
                oLanguage: { sSearch: "Filter Within These Results: " },
                iDisplayLength: window.Configuration.DataTablesPageSize,
                sDom: 'T<"clear">lfrtip',
                "fnDrawCallback": function (oSettings) {
                    $(".showTip").qtip({
                        overwrite: false,
                        show: {
                            event: 'mouseenter focus',
                            ready: false
                        },
                        hide: {
                            event: 'mouseleave blur'
                        },
                        position: {
                            my: 'bottom center',
                            at: 'top center'
                        }
                    });
                    $(".workgroupDetails").click(function() {
                        var temp = $(this);
                        var orderId = temp.data("id");
                        var role = temp.data("role");
                        //alert(orderId + role);
                        var url = '@Url.Action("GetPeeps", "Order")';
                        var dialogList = $("#peepsUl");
                        dialogList.empty();
                        $("#peepsDialog").dialog("open");
                        $("#peepsLoaderId").show();
                        $.getJSON(url,
                            { id: orderId, orderStatusCodeId: role },
                            function(result) {
                                $("#peepsLoaderId").hide();
                                if (result == null || result.success == false) {
                                    alert("There was a problem getting the list of users.");
                                } else {
                                    $(result.peeps).each(function() {
                                        dialogList.append("<li>" + this.FullName + " " + this.Email + "</li>");
                                    });
                                }
                            });
                    });
                },
                oTableTools: {
                    sSwfPath: window.Configuration.TableToolsSwf,
                    aButtons: ["copy", "xls"]
                }
            });

            $.each($(".dataTables_wrapper"), function(index, item) {
                RearranngeDataTable($(item));
            });

            if (window.Configuration.LoadFixedHeaders) {
                new FixedHeader(table);
            };
        });


        $(function() {
            $("#filterToggle").click(function() {
                $(".dt-table-filter-header").toggle();
                $(this).toggleClass("selected");
                event.preventDefault();
            });
        });

        $(document).ready(function() {
            $("#peepsDialog").dialog({
                autoOpen: false,
                height: 610,
                width: 500,
                modal: true,
                buttons: {
                    "Cancel": function() {
                        $("#peepsUl").empty();
                        $("#peepsLoaderId").hide();
                        $(this).dialog("close");
                    }
                }
            });


        });

        $(function() {
            $(".workgroupDetails").click(function() {
                var temp = $(this);
                var orderId = temp.data("id");
                var role = temp.data("role");
                //alert(orderId + role);
                var url = '@Url.Action("GetPeeps", "Order")';
                var dialogList = $("#peepsUl");
                dialogList.empty();
                $("#peepsDialog").dialog("open");
                $("#peepsLoaderId").show();
                $.getJSON(url,
                    { id: orderId, orderStatusCodeId: role },
                    function(result) {
                        $("#peepsLoaderId").hide();
                        if (result == null || result.success == false) {
                            alert("There was a problem getting the list of users.");
                        } else {
                            $(result.peeps).each(function() {
                                dialogList.append("<li>" + this.FullName + " " + this.Email + "</li>");
                            });
                        }
                    });
            });
        });
    </script>
}




    @if (string.IsNullOrWhiteSpace(Model.ShowLast))
    {
        @Html.Partial("_OrderFilter", Model)
    }

    @Html.Partial("_OrdersTable", Model)

    @Html.Partial("_PeepsDialog")