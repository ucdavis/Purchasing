@using Purchasing.Core.Domain
@model ReviewOrderViewModel
           
@{
    var externalApprovalIds = Model.ExternalApprovals.Select(x => x.Id);
    var internalApprovals = Approval.FilterUnique(Model.Approvals.Where(x => !externalApprovalIds.Contains(x.Id)).ToList());
    var orderedUniqueApprovals = internalApprovals.Union(Model.ExternalApprovals).OrderBy(a => a.StatusCode.Level);
}

@if (!Model.Complete)
{
    <section id="approvals" class="ui-corner-all display-form">

        <header class="ui-corner-top ui-widget-header">Approvals</header>

        <div class="section-contents">
    
            <table class="noicon">
                <tbody>
                    @foreach (var approval in orderedUniqueApprovals)
                    {
                        var approvalDisplayName = (approval.User != null ? approval.User.FullName : string.Format("[Any Workgroup {0}]", approval.StatusCode.Name)) + (approval.SecondaryUser != null ? "or " + approval.SecondaryUser.FullName : string.Empty);
                        <tr class='@(approval.Completed ? "approval-complete" : "approval-incomplete")'>
                            <td>@approval.StatusCode.Name</td>
                            <td class="name">
                                @approvalDisplayName
                                @if (approval.User == null)
                                {
                                    <a class='workgroupDetails showTip ui-icon ui-icon-person' data-role='@approval.StatusCode.Id' title='Lookup all the people who have workgroup access to this order at this Status.'></a>
                                }
                            </td>
                            <td>@(approval.Completed ? "Approved" : "Pending")</td>
                            @if (Model.CanEditOrder)
                            {
                                <td>
                                    @if (!approval.Completed && approval.StatusCode.Level == Model.Order.StatusCode.Level && Model.ExternalApprovals.Contains(approval))
                                    {
                                        <a href="#" class="button reroute" data-approval-id="@approval.Id">ReRoute Approval</a>
                                    @*<a href="#" class="button update" style="display:none;">Update</a>
                                    <a href="#" class="button cancel" style="display:none;">Cancel</a>*@
                                    } else if (approval.User==null && approval.StatusCode.Id == OrderStatusCode.Codes.Purchaser && (Model.Order.StatusCode.Id== OrderStatusCode.Codes.Purchaser || Model.Order.StatusCode.Id==OrderStatusCode.Codes.AccountManager))
                                           {
                                                @Html.ActionLink("Reroute Purchaser", "ReroutePurchaser", new { id = Model.Order.Id }, new { @Class = "button" }) 
                                           }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
    
        </div>

        <div id="reroute-search" title="Reroute Approval" style="display: none;">

            Email/Kerberos: <input type="text" id="reroute-person"/>    

            <input type="hidden" id="selected-orderId" value="@Model.Order.Id"/>
            <input type="hidden" id="selected-approval" />
            <input type="hidden" id="selected-person" />
        
        </div>

    </section>
}

@Html.Partial("_PeepsDialog")