var qq=qq||{};qq.FileUploader=function(b){this._options={element:null,action:"/server/upload",params:{},allowedExtensions:[],sizeLimit:0,onSubmit:function(c,d){},onComplete:function(c,d,e){},template:'<div class="qq-uploader"><div class="qq-upload-drop-area"><span>Drop files here to upload</span></div><div class="qq-upload-button">Upload a file</div><ul class="qq-upload-list"></ul></div>',fileTemplate:'<li><span class="qq-upload-file"></span><span class="qq-upload-spinner"></span><span class="qq-upload-size"></span><a class="qq-upload-cancel" href="#">Cancel</a><span class="qq-upload-failed-text">Failed</span></li>',classes:{button:"qq-upload-button",drop:"qq-upload-drop-area",dropActive:"qq-upload-drop-area-active",list:"qq-upload-list",file:"qq-upload-file",spinner:"qq-upload-spinner",size:"qq-upload-size",cancel:"qq-upload-cancel",success:"qq-upload-success",fail:"qq-upload-fail"},messages:{serverError:"Some files were not uploaded, please contact support and/or try again.",typeError:"{file} has invalid extension. Only {extensions} are allowed.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",emptyError:"{file} is empty, please select files again without it."},showMessage:function(c){alert(c)}};qq.extend(this._options,b);this._element=this._options.element;if(this._element.nodeType!=1){throw new Error("element param of FileUploader should be dom node")}this._element.innerHTML=this._options.template;this._filesInProgress=0;this._classes=this._options.classes;this._handler=this._createUploadHandler();this._bindCancelEvent();var a=this;this._button=new qq.UploadButton({element:this._getElement("button"),multiple:qq.UploadHandlerXhr.isSupported(),onChange:function(c){a._onInputChange(c)}});this._setupDragDrop()};qq.FileUploader.prototype={setParams:function(a){this._options.params=a},isUploading:function(){return !!this._filesInProgress},_getElement:function(a,b){if(typeof a=="string"){b=a;a=this._element}var c=qq.getByClass(a,this._options.classes[b])[0];if(!c){throw new Error("element not found "+b)}return c},_error:function(a,c){var b=this._options.messages[a];b=b.replace("{file}",this._formatFileName(c));b=b.replace("{extensions}",this._options.allowedExtensions.join(", "));b=b.replace("{sizeLimit}",this._formatSize(this._options.sizeLimit));this._options.showMessage(b)},_formatFileName:function(a){if(a.length>33){a=a.slice(0,19)+"..."+a.slice(-13)}return a},_isAllowedExtension:function(c){var d=(-1!==c.indexOf("."))?c.replace(/.*[.]/,"").toLowerCase():"";var a=this._options.allowedExtensions;if(!a.length){return true}for(var b=0;b<a.length;b++){if(a[b].toLowerCase()==d){return true}}return false},_setupDragDrop:function(){var c=this,b=this._getElement("drop");var a=new qq.UploadDropZone({element:b,onEnter:function(d){qq.addClass(b,c._classes.dropActive);d.stopPropagation()},onLeave:function(d){d.stopPropagation()},onLeaveNotDescendants:function(d){qq.removeClass(b,c._classes.dropActive)},onDrop:function(d){b.style.display="none";qq.removeClass(b,c._classes.dropActive);c._uploadFileList(d.dataTransfer.files)}});b.style.display="none";qq.attach(document,"dragenter",function(d){if(!a._isValidFileDrag(d)){return}b.style.display="block"});qq.attach(document,"dragleave",function(f){if(!a._isValidFileDrag(f)){return}var d=document.elementFromPoint(f.clientX,f.clientY);if(!d||d.nodeName=="HTML"){b.style.display="none"}})},_createUploadHandler:function(){var c=this,b;if(qq.UploadHandlerXhr.isSupported()){b="UploadHandlerXhr"}else{b="UploadHandlerForm"}var a=new qq[b]({action:this._options.action,onProgress:function(d,f,g,e){c._updateProgress(d,g,e)},onComplete:function(e,g,f){c._filesInProgress--;var d=c._getItemByFileId(e);qq.remove(c._getElement(d,"cancel"));qq.remove(c._getElement(d,"spinner"));if(f.success){qq.addClass(d,c._classes.success)}else{qq.addClass(d,c._classes.fail);if(f.error){c._options.showMessage(f.error)}}c._options.onComplete(e,g,f)}});return a},_onInputChange:function(a){if(this._handler instanceof qq.UploadHandlerXhr){this._uploadFileList(a.files)}else{if(this._validateFile(a)){this._uploadFile(a)}}this._button.reset()},_uploadFileList:function(b){var c=true;var a=b.length;while(a--){if(!this._validateFile(b[a])){c=false;break}}if(c){var a=b.length;while(a--){this._uploadFile(b[a])}}},_uploadFile:function(b){var a=this._handler.add(b);var c=this._handler.getName(a);this._options.onSubmit(a,c);this._addToList(a,c);this._handler.upload(a,this._options.params)},_validateFile:function(b){var c,a;if(b.value){c=b.value.replace(/.*(\/|\\)/,"")}else{c=b.fileName!=null?b.fileName:b.name;a=b.fileSize!=null?b.fileSize:b.size}if(!this._isAllowedExtension(c)){this._error("typeError",c);return false}else{if(a===0){this._error("emptyError",c);return false}else{if(a&&this._options.sizeLimit&&a>this._options.sizeLimit){this._error("sizeError",c);return false}}}return true},_addToList:function(b,d){var a=qq.toElement(this._options.fileTemplate);a.qqFileId=b;var c=this._getElement(a,"file");qq.setText(c,this._formatFileName(d));this._getElement(a,"size").style.display="none";this._getElement("list").appendChild(a);this._filesInProgress++},_updateProgress:function(c,e,b){var f=this._getItemByFileId(c);var a=this._getElement(f,"size");a.style.display="inline";var d;if(e!=b){d=Math.round(e/b*100)+"% from "+this._formatSize(b)}else{d=this._formatSize(b)}qq.setText(a,d)},_formatSize:function(a){var b=-1;do{a=a/1024;b++}while(a>99);return Math.max(a,0.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][b]},_getItemByFileId:function(a){var b=this._getElement("list").firstChild;while(b){if(b.qqFileId==a){return b}b=b.nextSibling}},_bindCancelEvent:function(){var a=this,b=this._getElement("list");qq.attach(b,"click",function(f){f=f||window.event;var c=f.target||f.srcElement;if(qq.hasClass(c,a._classes.cancel)){qq.preventDefault(f);var d=c.parentNode;a._handler.cancel(d.qqFileId);qq.remove(d)}})}};qq.UploadDropZone=function(a){this._options={element:null,onEnter:function(b){},onLeave:function(b){},onLeaveNotDescendants:function(b){},onDrop:function(b){}};qq.extend(this._options,a);this._element=this._options.element;this._disableDropOutside();this._attachEvents()};qq.UploadDropZone.prototype={_disableDropOutside:function(a){if(!qq.UploadDropZone.dropOutsideDisabled){qq.attach(document,"dragover",function(b){b.dataTransfer.dropEffect="none";b.preventDefault()});qq.UploadDropZone.dropOutsideDisabled=true}},_attachEvents:function(){var a=this;qq.attach(a._element,"dragover",function(b){if(!a._isValidFileDrag(b)){return}var c=b.dataTransfer.effectAllowed;if(c=="move"||c=="linkMove"){b.dataTransfer.dropEffect="move"}else{b.dataTransfer.dropEffect="copy"}b.stopPropagation();b.preventDefault()});qq.attach(a._element,"dragenter",function(b){if(!a._isValidFileDrag(b)){return}a._options.onEnter(b)});qq.attach(a._element,"dragleave",function(c){if(!a._isValidFileDrag(c)){return}a._options.onLeave(c);var b=document.elementFromPoint(c.clientX,c.clientY);if(qq.contains(this,b)){return}a._options.onLeaveNotDescendants(c)});qq.attach(a._element,"drop",function(b){if(!a._isValidFileDrag(b)){return}b.preventDefault();a._options.onDrop(b)})},_isValidFileDrag:function(c){var a=c.dataTransfer,b=navigator.userAgent.indexOf("AppleWebKit")>-1;return a&&a.effectAllowed!="none"&&(a.files||(!b&&a.types.contains&&a.types.contains("Files")))}};qq.UploadButton=function(a){this._options={element:null,multiple:false,name:"file",onChange:function(b){},hoverClass:"qq-upload-button-hover",focusClass:"qq-upload-button-focus"};qq.extend(this._options,a);this._element=this._options.element;qq.css(this._element,{position:"relative",overflow:"hidden",direction:"ltr"});this._input=this._createInput()};qq.UploadButton.prototype={getInput:function(){return this._input},reset:function(){if(this._input.parentNode){qq.remove(this._input)}qq.removeClass(this._element,this._options.focusClass);this._input=this._createInput()},_createInput:function(){var a=document.createElement("input");if(this._options.multiple){a.setAttribute("multiple","multiple")}a.setAttribute("type","file");a.setAttribute("name",this._options.name);qq.css(a,{position:"absolute",right:0,top:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,cursor:"pointer",opacity:0});this._element.appendChild(a);var b=this;qq.attach(a,"change",function(){b._options.onChange(a)});qq.attach(a,"mouseover",function(){qq.addClass(b._element,b._options.hoverClass)});qq.attach(a,"mouseout",function(){qq.removeClass(b._element,b._options.hoverClass)});qq.attach(a,"focus",function(){qq.addClass(b._element,b._options.focusClass)});qq.attach(a,"blur",function(){qq.removeClass(b._element,b._options.focusClass)});if(window.attachEvent){a.setAttribute("tabIndex","-1")}return a}};qq.UploadHandlerForm=function(a){this._options={action:"/upload",onComplete:function(b,c,d){}};qq.extend(this._options,a);this._inputs={}};qq.UploadHandlerForm.prototype={add:function(b){b.setAttribute("name","qqfile");var a="qq-upload-handler-iframe"+qq.getUniqueId();this._inputs[a]=b;if(b.parentNode){qq.remove(b)}return a},upload:function(f,b){var e=this._inputs[f];if(!e){throw new Error("file with passed id was not added, or already uploaded or cancelled")}var a=this.getName(f);var g=this._createIframe(f);var d=this._createForm(g,b);d.appendChild(e);var c=this;this._attachLoadEvent(g,function(){c._options.onComplete(f,a,c._getIframeContentJSON(g));delete c._inputs[f];setTimeout(function(){qq.remove(g)},1)});d.submit();qq.remove(d);return f},cancel:function(a){if(a in this._inputs){delete this._inputs[a]}var b=document.getElementById(a);if(b){b.setAttribute("src","javascript:false;");qq.remove(b)}},getName:function(a){return this._inputs[a].value.replace(/.*(\/|\\)/,"")},_attachLoadEvent:function(b,a){qq.attach(b,"load",function(){if(!b.parentNode){return}if(b.contentDocument&&b.contentDocument.body&&b.contentDocument.body.innerHTML=="false"){return}a()})},_getIframeContentJSON:function(iframe){var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response;try{response=eval("("+doc.body.innerHTML+")")}catch(err){response={}}return response},_createIframe:function(a){var b=qq.toElement('<iframe src="javascript:false;" name="'+a+'" />');b.setAttribute("id",a);b.style.display="none";document.body.appendChild(b);return b},_createForm:function(b,c){var a=qq.toElement('<form method="post" enctype="multipart/form-data"></form>');var d="?"+qq.obj2url(c);a.setAttribute("action",this._options.action+d);a.setAttribute("target",b.name);a.style.display="none";document.body.appendChild(a);return a}};qq.UploadHandlerXhr=function(a){this._options={action:"/upload",onProgress:function(b,d,e,c){},onComplete:function(b,c,d){}};qq.extend(this._options,a);this._files=[];this._xhrs=[]};qq.UploadHandlerXhr.isSupported=function(){var a=document.createElement("input");a.type="file";return("multiple" in a&&typeof File!="undefined"&&typeof(new XMLHttpRequest()).upload!="undefined")};qq.UploadHandlerXhr.prototype={add:function(a){return this._files.push(a)-1},upload:function(id,params){var file=this._files[id],name=this.getName(id),size=this.getSize(id);if(!file){throw new Error("file with passed id was not added, or already uploaded or cancelled")}var xhr=this._xhrs[id]=new XMLHttpRequest();var self=this;xhr.upload.onprogress=function(e){if(e.lengthComputable){self._options.onProgress(id,name,e.loaded,e.total)}};xhr.onreadystatechange=function(){if(!self._files[id]){return}if(xhr.readyState==4){self._options.onProgress(id,name,size,size);if(xhr.status==200){var response;try{response=eval("("+xhr.responseText+")")}catch(err){response={}}self._options.onComplete(id,name,response)}else{self._options.onComplete(id,name,{})}self._files[id]=null;self._xhrs[id]=null}};var queryString="?qqfile="+encodeURIComponent(name)+"&"+qq.obj2url(params);xhr.open("POST",this._options.action+queryString,true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.setRequestHeader("X-File-Name",encodeURIComponent(name));xhr.send(file)},cancel:function(a){this._files[a]=null;if(this._xhrs[a]){this._xhrs[a].abort();this._xhrs[a]=null}},getName:function(a){var b=this._files[a];return b.fileName!=null?b.fileName:b.name},getSize:function(a){var b=this._files[a];return b.fileSize!=null?b.fileSize:b.size}};var qq=qq||{};qq.extend=function(c,a){for(var b in a){c[b]=a[b]}};qq.getUniqueId=(function(){var a=0;return function(){return a++}})();qq.attach=function(c,b,a){if(c.addEventListener){c.addEventListener(b,a,false)}else{if(c.attachEvent){c.attachEvent("on"+b,a)}}};qq.detach=function(c,b,a){if(c.removeEventListener){c.removeEventListener(b,a,false)}else{if(c.attachEvent){c.detachEvent("on"+b,a)}}};qq.preventDefault=function(a){if(a.preventDefault){a.preventDefault()}else{a.returnValue=false}};qq.insertBefore=function(c,d){d.parentNode.insertBefore(c,d)};qq.remove=function(a){a.parentNode.removeChild(a)};qq.contains=function(a,b){if(a==b){return true}if(a.contains){return a.contains(b)}else{return !!(b.compareDocumentPosition(a)&8)}};qq.toElement=(function(){var a=document.createElement("div");return function(b){a.innerHTML=b;var c=a.firstChild;a.removeChild(c);return c}})();qq.css=function(a,b){if(b.opacity!=null){if(typeof a.style.opacity!="string"&&typeof(a.filters)!="undefined"){b.filter="alpha(opacity="+Math.round(100*b.opacity)+")"}}qq.extend(a.style,b)};qq.hasClass=function(b,c){var a=new RegExp("(^| )"+c+"( |$)");return a.test(b.className)};qq.addClass=function(a,b){if(!qq.hasClass(a,b)){a.className+=" "+b}};qq.removeClass=function(b,c){var a=new RegExp("(^| )"+c+"( |$)");b.className=b.className.replace(a," ").replace(/^\s+|\s+$/g,"")};qq.setText=function(a,b){a.innerText=b;a.textContent=b};qq.children=function(b){var c=[],a=b.firstChild;while(a){if(a.nodeType==1){c.push(a)}a=a.nextSibling}return c};qq.getByClass=function(b,e){if(b.querySelectorAll){return b.querySelectorAll("."+e)}var a=[];var f=b.getElementsByTagName("*");var d=f.length;for(var c=0;c<d;c++){if(qq.hasClass(f[c],e)){a.push(f[c])}}return a};qq.obj2url=function(f,e){var d=[],b=function(j,g){var h=e?(/\[\]$/.test(e))?e:e+"["+g+"]":g;d.push(typeof j==="object"?qq.obj2url(j,h):(Object.prototype.toString.call(j)==="[object Function]")?encodeURIComponent(h)+"="+encodeURIComponent(j()):encodeURIComponent(h)+"="+encodeURIComponent(j))};if(Object.prototype.toString.call(f)==="[object Array]"){for(var a=0,c=f.length;a<c;++a){b(f[a],a)}}else{if((f!==undefined)&&(f!==null)&&(typeof f==="object")){for(var a in f){b(f[a],a)}}else{d.push(encodeURIComponent(e)+"="+encodeURIComponent(f))}}return d.join("&").replace(/%20/g,"+")};